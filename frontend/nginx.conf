# =============================================================================
# nginx.conf - Nginx Configuration for React SPA
# =============================================================================
# This configuration handles:
# 1. Serving the React static files
# 2. SPA routing (all routes -> index.html)
# 3. API proxying to the backend service
#
# NGINX CONCEPTS:
# ---------------
# - server: Defines a virtual server (like a website)
# - location: Rules for handling different URL paths
# - proxy_pass: Forward requests to another server
# - try_files: Try to serve files, fallback to index.html
# =============================================================================

server {
    # -------------------------------------------------------------------------
    # Listen on port 80 (HTTP)
    # -------------------------------------------------------------------------
    # Inside the container, Nginx listens on port 80.
    # Docker maps this to port 3000 on the host.
    # -------------------------------------------------------------------------
    listen 80;
    server_name localhost;

    # -------------------------------------------------------------------------
    # Root Directory
    # -------------------------------------------------------------------------
    # Where the built React files are located (copied in Dockerfile).
    # -------------------------------------------------------------------------
    root /usr/share/nginx/html;
    index index.html;

    # -------------------------------------------------------------------------
    # API Proxy
    # -------------------------------------------------------------------------
    # Forward all /api/* requests to the backend service.
    #
    # HOW THIS WORKS:
    # 1. Frontend makes request to /api/settings
    # 2. Nginx receives the request
    # 3. Nginx forwards to http://backend:8000/settings (strips /api prefix)
    # 4. Backend responds
    # 5. Nginx forwards response back to frontend
    #
    # 'backend' is the Docker service name from docker-compose.yml.
    # Docker's internal DNS resolves 'backend' to the backend container's IP.
    # -------------------------------------------------------------------------
    location /api/ {
        # Forward to backend service, stripping the /api prefix
        # rewrite removes /api from the path before forwarding
        rewrite ^/api/(.*) /$1 break;

        # The backend service name as defined in docker-compose.yml
        proxy_pass http://backend:8000;

        # Pass important headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # -------------------------------------------------------------------------
    # Static Files & SPA Routing
    # -------------------------------------------------------------------------
    # For all other requests:
    # 1. Try to serve the exact file requested
    # 2. Try to serve it as a directory (with index.html)
    # 3. Fall back to index.html (for SPA client-side routing)
    #
    # This is crucial for React Router! Without it, refreshing on /subjects
    # would return 404 instead of loading the app.
    # -------------------------------------------------------------------------
    location / {
        try_files $uri $uri/ /index.html;
    }

    # -------------------------------------------------------------------------
    # Cache Static Assets
    # -------------------------------------------------------------------------
    # Cache JavaScript, CSS, and image files for 1 year.
    # Vite adds content hashes to filenames, so new deploys get new URLs.
    # -------------------------------------------------------------------------
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # -------------------------------------------------------------------------
    # Gzip Compression
    # -------------------------------------------------------------------------
    # Compress text-based responses to reduce bandwidth.
    # -------------------------------------------------------------------------
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
    gzip_min_length 1000;

    # -------------------------------------------------------------------------
    # Security Headers
    # -------------------------------------------------------------------------
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
}
